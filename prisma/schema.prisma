generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   STUDENT
========================= */

model Student {
  id        String   @id @default(cuid())
  apolloId  String?  @unique // externe sleutel (Apollo)
  name      String
  createdAt DateTime @default(now())

  assessments Assessment[]
  cohorts     CohortStudent[]
}

/* =========================
   TEACHER (docentenpool)
========================= */

model Teacher {
  id        String   @id @default(cuid())
  apolloId  String?  @unique // externe sleutel (Apollo)
  name      String
  email     String?  @unique
  createdAt DateTime @default(now())

  cohorts CohortTeacher[]
  reviews TeacherReview[]
  scores  TeacherScore[]
}

/* =========================
   ASSESSMENT
========================= */

model Assessment {
  id        String   @id @default(cuid())
  studentId String
  moment    String   // "M1" | "M2" | "M3"
  rubricKey String   // "1VO" | "2VO" | "3VO"
  status    String   @default("draft")
  createdAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  scores  Score[]

  review TeacherReview?

  @@unique([studentId, moment, rubricKey])
}

/* =========================
   STUDENT SCORE
========================= */

model Score {
  id           String   @id @default(cuid())
  assessmentId String
  themeId      String
  questionId   String
  score        Int
  comment      String?  @db.Text
  updatedAt    DateTime @updatedAt

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, themeId, questionId])
}

/* =========================
   REVIEW STATUS ENUM
========================= */

enum ReviewStatus {
  DRAFT
  PUBLISHED
}

/* =========================
   TEACHER REVIEW (1 per assessment)
========================= */

model TeacherReview {
  id String @id @default(cuid())

  assessmentId String     @unique
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  correctedScore Int?
  feedback       String? @db.Text

  status      ReviewStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
  @@index([status])
}

/* =========================
   COHORT (bijv. 1VO 2026)
========================= */

model Cohort {
  id        String   @id @default(cuid())
  apolloId  String?  @unique // externe sleutel (Apollo)
  title     String   // "1VO 2026"
  rubricKey String   // "1vo" | "2vo" | "3vo"
  year      Int
  createdAt DateTime @default(now())

  students CohortStudent[]
  teachers CohortTeacher[]

  @@unique([rubricKey, year])
}

/* =========================
   STUDENT ↔ COHORT
========================= */

model CohortStudent {
  id        String   @id @default(cuid())
  cohortId  String
  studentId String
  createdAt DateTime @default(now())

  cohort  Cohort  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([cohortId, studentId])
  @@index([studentId])
  @@index([cohortId])
}

/* =========================
   TEACHER ↔ COHORT
========================= */

model CohortTeacher {
  id        String   @id @default(cuid())
  cohortId  String
  teacherId String
  createdAt DateTime @default(now())

  cohort  Cohort  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([cohortId, teacherId])
  @@index([teacherId])
  @@index([cohortId])
}

/* =========================
   PER-QUESTION DOCENTCORRECTIE
========================= */

model TeacherScore {
  id String @id @default(cuid())

  assessmentId String
  teacherId    String
  teacher      Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  themeId    String
  questionId String

  correctedScore Int?
  feedback       String? @db.Text

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([assessmentId, teacherId, themeId, questionId])
  @@index([assessmentId])
  @@index([teacherId])
}